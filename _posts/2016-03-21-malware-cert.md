---
layout:     post
title:      Malware Certificates
date:       2016-03-21 00:53:29
summary:    Malware Certificate Research
categories: research code malware security certificates
---

### Overview
If you are familiar with malware, you’ll know that signed malware is not something new. Why code sign your malware? Because it is cool and you get a green (check mark, seal,  etc.). Besides being cool, it allows you to bypass some security mechanisms built-in operating systems and fool (fake/real)anti-virus.

I grabbed 3 million samples from QCRI’s malware repository and extracted any embedded certificates found in the malware. If the malware is signed then I get the certificate chain from the Authenticode signature, if not then I search the resources for any X509 structures. 

I built a web application that hosts this data and wrote a small paper discussing high-level statistics found from this endeavor. You can find all the work here [MalCert](http://malcert.localhost.qa/). The rest of the blog I am just going to briefly talk about how I did it.

### How To
I started out by identifying all samples that have a PKCS#7 or X509 embeds in their bodies. To do this, I used a python library called [pefile](https://github.com/erocarrera/pefile). I used the following code to look for certificate embeds:

{% highlight python %}
fStream=open(filename,'rb').read()
try:
	pe = pefile.PE(data=fStream,fast_load=False)

	#get cert vAddr and size, if exists: this let's us know if there is an embedded certificate
	try:
		dAddr=pe.OPTIONAL_HEADER.DATA_DIRECTORY[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_SECURITY']].VirtualAddress
		dSize=pe.OPTIONAL_HEADER.DATA_DIRECTORY[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_SECURITY']].Size
		ifdAddr!=0 or dSize!=0:
			cert=pe.write()[dAddr+8:dAddr+8+dSize]
		rslt=dump_content(cert)
	except Exception e:
		return None
excep Exception e:
	return None
{% endhighlight %}

Once you have the certificate you can start parsing it manually or using libraries. I used a hybrid approach by using the [ASN python library](http://pyasn1.sourceforge.net/) and custom code to extract the fields of interest. I ended up with about 800K samples, which I used [VirusTotal](https://www.virustotal.com/) to get the detections and make sure the samples I have are malware.

Head over to [MalCert](http://malcert.localhost.qa/) and fiddle around a bit. If you have any questions please feel free to contact me.


